#!/usr/bin/env ruby
# Script to setup JWT authentication

require 'securerandom'
require 'fileutils'

puts "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –º–µ–¥–∏–∞—Å–µ—Ä–≤–∏—Å–∞ '–°–º—ã—Å–ª'"
puts "=" * 60

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞
puts "\n1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞..."
jwt_key = SecureRandom.hex(64)
puts "‚úÖ JWT –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: #{jwt_key[0..20]}..."

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞
puts "\n2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª—é—á–∞..."
puts "‚ö†Ô∏è  –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–ª—é—á –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ!"
puts "\n–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ –≤–∞—à config/credentials.yml.enc:"
puts "\njwt_signing_key: #{jwt_key}"
puts "\n–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è credentials:"
puts "EDITOR=\"code --wait\" bin/rails credentials:edit"

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –∫–ª—é—á–æ–º –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
puts "\n3. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .env –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
File.open('.env', 'a') do |f|
  f.puts "\n# JWT Secret Key (–ù–ï –ö–û–ú–ú–ò–¢–ò–¢–¨ –í GIT!)"
  f.puts "JWT_SIGNING_KEY=#{jwt_key}"
end

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .gitignore
puts "\n4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .gitignore..."
gitignore_content = File.read('.gitignore') rescue ''
unless gitignore_content.include?('.env')
  File.open('.gitignore', 'a') do |f|
    f.puts "\n# Environment variables"
    f.puts ".env"
  end
  puts "‚úÖ .env –¥–æ–±–∞–≤–ª–µ–Ω –≤ .gitignore"
end

puts "\n" + "=" * 60
puts "‚ú® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
puts "=" * 60

puts "\n–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
puts "1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: bundle install"
puts "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: rails db:migrate"
puts "3. –î–æ–±–∞–≤—å—Ç–µ jwt_signing_key –≤ credentials (—Å–º. –≤—ã—à–µ)"
puts "4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: rails server"
puts "\nüìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: —Å–º. QUICKSTART.md –∏ JWT_API_SETUP.md"
